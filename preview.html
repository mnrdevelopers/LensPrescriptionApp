<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prescription Preview</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <button onclick="window.location.href = 'app.html';" class="btn btn-back">
    <i class="fas fa-arrow-left"></i> Back
</button>
    
    <div id="prescriptionPreview" style="display: block; width: 58mm; padding: 5px; font-family: Times New Roman, sans-serif; font-size: 8px;">
        <!-- Clinic Details -->
        <div style="text-align: center; margin-bottom: 5px;">
            <h2 id="previewClinicName" style="font-size: 10px; margin: 0;">Loading...</h2>
            <p id="previewClinicAddress" style="font-size: 8px; margin: 2px 0;">Please wait...</p>
        </div>
        <hr style="border: 0.5px dashed #000; margin: 5px 0;">

        <!-- Optometrist Details -->
        <div style="margin-bottom: 5px;">
            <p id="previewOptometristName" style="margin: 2px 0;"><strong>Loading...</strong></p>
            <p id="previewContactNumber" style="margin: 2px 0;"><strong>Please wait...</strong></p>
            <p style="margin: 2px 0;"><strong>Date:</strong> <span id="previewcurrentDate"></span></p>
        </div>
        <hr style="border: 0.5px dashed #000; margin: 5px 0;">

        <!-- Patient Details -->
        <div style="margin-bottom: 5px;">
            <p style="margin: 2px 0;"><strong>Patient Name:</strong> <span id="previewPatientName"></span></p>
            <p style="margin: 2px 0;"><strong>Age:</strong> <span id="previewAge"></span></p>
            <p style="margin: 2px 0;"><strong>Gender:</strong> <span id="previewGender"></span></p>
            <p style="margin: 2px 0;"><strong>Mobile:</strong> <span id="previewMobile"></span></p>
        </div>
        <hr style="border: 0.5px dashed #000; margin: 5px 0;">

        <!-- Prescription Details -->
        <div style="margin-bottom: 5px;">
            <h3 style="font-size: 9px; margin: 5px 0; text-align: center;">Prescription Details</h3>

            <!-- Right Eye Table -->
            <table style="width: 100%; border-collapse: collapse; font-size: 8px; margin-bottom: 10px;">
                <thead>
                    <tr>
                        <th colspan="5">RIGHT EYE (OD)</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>SPH</th>
                        <th>CYL</th>
                        <th>AXIS</th>
                        <th>V/A</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>DIST</strong></td>
                        <td><span id="previewRightDistSPH"></span></td>
                        <td><span id="previewRightDistCYL"></span></td>
                        <td><span id="previewRightDistAXIS"></span></td>
                        <td><span id="previewRightDistVA"></span></td>
                    </tr>
                    <tr>
                        <td><strong>ADD</strong></td>
                        <td><span id="previewRightAddSPH"></span></td>
                        <td><span id="previewRightAddCYL"></span></td>
                        <td><span id="previewRightAddAXIS"></span></td>
                        <td><span id="previewRightAddVA"></span></td>
                    </tr>
                </tbody>
            </table>

            <!-- Left Eye Table -->
            <table style="width: 100%; border-collapse: collapse; font-size: 8px;">
                <thead>
                    <tr>
                        <th colspan="5">LEFT EYE (OS)</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>SPH</th>
                        <th>CYL</th>
                        <th>AXIS</th>
                        <th>V/A</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>DIST</strong></td>
                        <td><span id="previewLeftDistSPH"></span></td>
                        <td><span id="previewLeftDistCYL"></span></td>
                        <td><span id="previewLeftDistAXIS"></span></td>
                        <td><span id="previewLeftDistVA"></span></td>
                    </tr>
                    <tr>
                        <td><strong>ADD</strong></td>
                        <td><span id="previewLeftAddSPH"></span></td>
                        <td><span id="previewLeftAddCYL"></span></td>
                        <td><span id="previewLeftAddAXIS"></span></td>
                        <td><span id="previewLeftAddVA"></span></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <hr style="border: 0.5px dashed #000; margin: 5px 0;">

        <!-- Vision Type, Lens Type, Frame Type, and Payment Mode -->
        <div style="margin-bottom: 5px;">
            <p style="margin: 2px 0;"><strong>Vision Type:</strong> <span id="previewVisionType"></span></p>
            <p style="margin: 2px 0;"><strong>Lens Type:</strong> <span id="previewLensType"></span></p>
            <p style="margin: 2px 0;"><strong>Frame Type:</strong> <span id="previewFrameType"></span></p>
        </div>
        <hr style="border: 0.5px dashed #000; margin: 5px 0;">

        <!-- Amount -->
        <div style="margin-bottom: 5px;">
            <p style="margin: 2px 0;"><strong>Amount:</strong> â‚¹<span id="previewAmount"></span></p>
            <p style="margin: 2px 0;"><strong>Payment Mode:</strong> <span id="previewPaymentMode"></span></p>
        </div>
        <hr style="border: 0.5px dashed #000; margin: 5px 0;">

        <!-- Thank You Note -->
        <div style="text-align: center; font-size: 8px; margin-top: 5px;">
            <p style="margin: 2px 0;">Thank you for choosing Us</p>
            <p id="previewClinicName" style="font-size: 10px; margin: 0;">Loading...</p>
            <p style="margin: 2px 0;">We hope to see you again soon.</p>
        </div>
    </div>

    <!-- Buttons -->
    <div class="buttons">
        <button id="downloadButton" onclick="generatePDF()" class="btn btn-download">
            <i class="fas fa-file-pdf"></i> PDF
        </button>

        <button id="printButton" onclick="window.print()" class="btn btn-print">
            <i class="fas fa-print"></i> Print
        </button>

        <button onclick="sendWhatsApp()" class="btn btn-whatsapp">
            <i class="fab fa-whatsapp"></i> WhatsApp
        </button>
    </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxXx0Jy7AmSljFYOuXs00Mxj4aiGpSHz92L5sa903Hp09lEQXrVbfNXByZoAOSogwUm/exec"; // Replace with your Google Apps Script URL

    document.addEventListener("DOMContentLoaded", function() {
        const username = localStorage.getItem("username");

        if (!username) {
            // Redirect to login page if no user is logged in
            window.location.href = "login.html";
            return;
        }

        // Fetch user details from Google Sheets
        fetch(scriptURL, {
            method: "POST",
            body: JSON.stringify({ action: "getDetails", username: username })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === "success") {
                // Update Clinic Details in Prescription Preview
                document.getElementById("previewClinicName").textContent = result.clinicName;
                document.getElementById("previewClinicAddress").textContent = result.address;
                document.getElementById("previewOptometristName").textContent = result.optometristName;
                document.getElementById("previewContactNumber").textContent = result.contactNumber;
            } else {
                alert("Error fetching clinic details. Please log in again.");
                localStorage.removeItem("username");
                window.location.href = "login.html";
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Failed to fetch clinic details. Please check your internet connection.");
        });

        // Set Current Date
        document.getElementById("previewcurrentDate").textContent = new Date().toLocaleDateString();
    });

    // Function to generate PDF
    function generatePDF() {
        const element = document.getElementById('prescriptionPreview');
        html2pdf()
            .set({
                margin: 5,
                filename: 'Lens_Prescription.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            })
            .from(element)
            .save();
    }

    // Function to send via WhatsApp
    function sendWhatsApp() {
        const mobileNumber = localStorage.getItem("patientMobile");
        if (!mobileNumber) {
            alert("Please enter a valid mobile number before sending.");
            return;
        }

        html2canvas(document.getElementById('prescriptionPreview'), { scale: 2 }).then(canvas => {
            const imageData = canvas.toDataURL("image/png");
            uploadImageToImgBB(imageData, mobileNumber);
        });
    }

    // Function to upload image to ImgBB and send via WhatsApp
    function uploadImageToImgBB(base64Image, mobileNumber) {
        const apiKey = "bbfde58b1da5fc9ee9d7d6a591852f71"; // Your ImgBB API Key
        const formData = new FormData();
        formData.append("image", base64Image.split(',')[1]);

        fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const imageURL = data.data.url;
                const message = "Here is your digital prescription from Lens Prescription App: " + imageURL;
                const whatsappURL = `https://wa.me/${mobileNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappURL, "_blank");
            } else {
                alert("Image upload failed. Please try again.");
            }
        })
        .catch(error => {
            console.error("Image upload error:", error);
            alert("Error uploading image. Please check your internet connection.");
        });
    }

    // Load data from localStorage
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("previewPatientName").textContent = localStorage.getItem("patientName");
        document.getElementById("previewAge").textContent = localStorage.getItem("age");
        document.getElementById("previewGender").textContent = localStorage.getItem("gender");
        document.getElementById("previewMobile").textContent = localStorage.getItem("patientMobile");
        document.getElementById("previewAmount").textContent = localStorage.getItem("amount");
        document.getElementById("previewVisionType").textContent = localStorage.getItem("visionType");
        document.getElementById("previewLensType").textContent = localStorage.getItem("lensType");
        document.getElementById("previewFrameType").textContent = localStorage.getItem("frameType");
        document.getElementById("previewPaymentMode").textContent = localStorage.getItem("paymentMode");

        // Prescription fields
        const prescriptionFields = [
            "rightDistSPH", "rightDistCYL", "rightDistAXIS", "rightDistVA",
            "leftDistSPH", "leftDistCYL", "leftDistAXIS", "leftDistVA",
            "rightAddSPH", "rightAddCYL", "rightAddAXIS", "rightAddVA",
            "leftAddSPH", "leftAddCYL", "leftAddAXIS", "leftAddVA"
        ];

        prescriptionFields.forEach(field => {
            document.getElementById(`preview${field}`).textContent = localStorage.getItem(field);
        });
    });

window.addEventListener("beforeunload", function() {
    localStorage.removeItem("patientName");
    localStorage.removeItem("age");
    localStorage.removeItem("gender");
    localStorage.removeItem("patientMobile");
    localStorage.removeItem("amount");
    localStorage.removeItem("visionType");
    localStorage.removeItem("lensType");
    localStorage.removeItem("frameType");
    localStorage.removeItem("paymentMode");
    localStorage.removeItem("currentDate");

    // Clear prescription fields
    const prescriptionFields = [
        "rightDistSPH", "rightDistCYL", "rightDistAXIS", "rightDistVA",
        "leftDistSPH", "leftDistCYL", "leftDistAXIS", "leftDistVA",
        "rightAddSPH", "rightAddCYL", "rightAddAXIS", "rightAddVA",
        "leftAddSPH", "leftAddCYL", "leftAddAXIS", "leftAddVA"
    ];

    prescriptionFields.forEach(field => {
        localStorage.removeItem(field);
    });
});
      
</script>
</body>
</html>
