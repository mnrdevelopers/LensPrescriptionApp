<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lens Prescription</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">

</head>
<body>

<!-- Custom Exit Prompt Modal -->
<div id="exitPromptModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 10000;">
    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
        <p>Are you sure you want to leave? Your changes may not be saved.</p>
        <button id="confirmExit">Yes, Leave</button>
        <button id="cancelExit">No, Stay</button>
    </div>
</div>
    
    <div id="prescription">
    <div class="dark-mode-toggle">
    <label class="switch">
        <input type="checkbox" id="darkModeToggle">
        <span class="slider round"></span>
    </label>
</div>

        <!-- Prescription Count and Amount Earned -->
        <button onclick="logoutUser()" class="btn btn-logout">Logout</button>

        <div class="prescription-stats">
            <div class="left">
                <p><strong>Prescription Count:</strong> <span id="prescriptionCount">0</span></p>
            </div>
            <div class="right">
                <p><strong>Amount Earned:</strong> â‚¹<span id="amountEarned">0</span></p>
            </div>
        </div>
        <div>
            <button id="resetButton" style="display: block;"> ðŸ”„</button>
            <button id="install-btn" style="display: none;">Install App</button>
        </div>
        <hr>
        
        <!-- Optical Shop Details -->
<div class="header">
    <h2 id="clinicName">Loading...</h2>
    <p id="clinicAddress">Please wait...</p>
</div>
<hr>

<!-- Optometrist Details -->
<div class="optometrist-details">
    <div class="left">
        <p><strong id="optometristName">Loading...</strong></p>
        <p><strong id="contactNumber">Please wait...</strong></p>
    </div>
    <div class="right">
        <p><strong>Date:</strong> <span id="currentDate"></span></p>
    </div>
</div>
<hr>

        <button onclick="openEditProfileModal()" class="btn btn-edit">Edit Profile</button>

<!-- Edit Profile Modal -->
<div id="editProfileModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 10000;">
    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
        <h3>Edit Profile</h3>
        <input type="text" id="editClinicName" placeholder="Clinic Name"><br><br>
        <input type="text" id="editOptometristName" placeholder="Optometrist Name"><br><br>
        <input type="text" id="editAddress" placeholder="Clinic Address"><br><br>
        <input type="tel" id="editContactNumber" placeholder="Contact Number"><br><br>
        <button onclick="saveProfileChanges()">Save</button>
        <button onclick="closeEditProfileModal()">Cancel</button>
    </div>
</div>

        <!-- Patient Details -->
        <div class="section-title">Patient Details</div>
        <div class="patient-details">
            <div>
                <label for="patientName">Patient Name</label>
                <input type="text" id="patientName" placeholder="Enter name" required>
            </div>
            <div>
                <label for="age">Age</label>
                <input type="number" id="age" placeholder="Age" required>
            </div>
            <div>
                <label for="gender">Gender</label>
                <select id="gender">
                    <option>Male</option>
                    <option>Female</option>
                    <option>Other</option>
                </select>
            </div>
            <div>
                <label for="patientMobile">Mobile</label>
                <input type="tel" id="patientMobile" placeholder="Enter mobile number" required pattern="[0-9]{10}">
            </div>
        </div>
        <hr>

  <!-- Prescription Details -->      
<div class="section-title">Prescription Details</div>
<div class="prescription-table">
    <!-- Right Eye Table -->
    <table>
        <thead>
            <tr>
                <th colspan="5">RIGHT EYE (OD)</th>
            </tr>
            <tr>
                <th></th>
                <th>SPH</th>
                <th>CYL</th>
                <th>AXIS</th>
                <th>V/A</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>DIST</strong></td>
                <td><input type="text" id="rightDistSPH" placeholder="SPH"></td>
                <td><input type="text" id="rightDistCYL" placeholder="CYL"></td>
                <td><input type="text" id="rightDistAXIS" placeholder="AXIS"></td>
                <td><input type="text" id="rightDistVA" placeholder="V/A"></td>
            </tr>
            <tr>
                <td><strong>ADD</strong></td>
                <td><input type="text" id="rightAddSPH" placeholder="SPH"></td>
                <td><input type="text" id="rightAddCYL" placeholder="CYL"></td>
                <td><input type="text" id="rightAddAXIS" placeholder="AXIS"></td>
                <td><input type="text" id="rightAddVA" placeholder="V/A"></td>
            </tr>
        </tbody>
    </table>

    <!-- Left Eye Table -->
    <table>
        <thead>
            <tr>
                <th colspan="5">LEFT EYE (OS)</th>
            </tr>
            <tr>
                <th></th>
                <th>SPH</th>
                <th>CYL</th>
                <th>AXIS</th>
                <th>V/A</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>DIST</strong></td>
                <td><input type="text" id="leftDistSPH" placeholder="SPH"></td>
                <td><input type="text" id="leftDistCYL" placeholder="CYL"></td>
                <td><input type="text" id="leftDistAXIS" placeholder="AXIS"></td>
                <td><input type="text" id="leftDistVA" placeholder="V/A"></td>
            </tr>
            <tr>
                <td><strong>ADD</strong></td>
                <td><input type="text" id="leftAddSPH" placeholder="SPH"></td>
                <td><input type="text" id="leftAddCYL" placeholder="CYL"></td>
                <td><input type="text" id="leftAddAXIS" placeholder="AXIS"></td>
                <td><input type="text" id="leftAddVA" placeholder="V/A"></td>
            </tr>
        </tbody>
    </table>
</div>
        <hr>

        <!-- Vision Type, Lens Type, and Frame Type Side by Side -->
<div class="section-title">Options</div>
<div class="options-row">
    <!-- Vision Type -->
    <div class="form-group">
        <label for="visionType">Vision Type</label>
        <select id="visionType">
            <option value="Single Vision">Single Vision</option>
            <option value="Bifocal">Bifocal</option>
            <option value="Progressive">Progressive</option>
            <option value="Reading">Reading</option>
        </select>
    </div>

    <!-- Lens Type -->
    <div class="form-group">
        <label for="lensType">Lens Type</label>
        <select id="lensType">
            <option value="Blue Cut">Blue Cut</option>
            <option value="Progressive">Progressive</option>
            <option value="Bifocal">Bifocal</option>
            <option value="Anti-Glare">Anti-Glare</option>
        </select>
    </div>

    <!-- Frame Type -->
    <div class="form-group">
        <label for="frameType">Frame Type</label>
        <select id="frameType">
            <option value="Full Rim">Full Rim</option>
            <option value="Half Rim">Half Rim</option>
            <option value="Rimless">Rimless</option>
            <option value="Metal">Metal</option>
            <option value="Plastic">Plastic</option>
        </select>
    </div>
</div>
<hr>
        
        <!-- Amount and Payment Mode Combined -->
<div class="section-title">Amount & Payment Mode</div>
<div class="amount-payment-row">
    <!-- Amount -->
    <div class="form-group">
        <label for="amount">Amount (â‚¹)</label>
        <input type="number" id="amount" placeholder="Enter amount" required>
    </div>

    <!-- Payment Mode -->
    <div class="form-group">
        <label for="paymentMode">Payment Mode</label>
        <select id="paymentMode">
            <option value="Cash">Cash</option>
            <option value="Card">Card</option>
            <option value="UPI">UPI</option>
            <option value="Online">Online</option>
        </select>
    </div>
</div>
<hr>

   <div class="buttons">
    <button id="downloadButton" onclick="generatePDF()" class="btn btn-download">
        <i class="fas fa-file-pdf"></i> PDF
    </button>

    <button id="printButton" onclick="window.print()" class="btn btn-print" disabled>
        <i class="fas fa-print"></i> Print
    </button>

    <button onclick="sendWhatsApp()" class="btn btn-whatsapp">
        <i class="fab fa-whatsapp"></i> WhatsApp
    </button>

    <button onclick="submitForm()" class="btn btn-submit">
        <i class="fas fa-paper-plane"></i> Submit
    </button>
</div>

        
      <div id="prescriptionPreview" style="display: none; width: 58mm; padding: 5px; font-family: Times New Roman, sans-serif; font-size: 8px;">
    <!-- Clinic Details -->
   <div style="text-align: center; margin-bottom: 5px;">
    <h2 id="previewClinicName" style="font-size: 10px; margin: 0;">Loading...</h2>
    <p id="previewClinicAddress" style="font-size: 8px; margin: 2px 0;">Please wait...</p>
</div>
<hr style="border: 0.5px dashed #000; margin: 5px 0;">

<!-- Optometrist Details -->
<div style="margin-bottom: 5px;">
    <p id="previewOptometristName" style="margin: 2px 0;"><strong>Loading...</strong></p>
    <p id="previewContactNumber" style="margin: 2px 0;"><strong>Please wait...</strong></p>
    <p style="margin: 2px 0;"><strong>Date:</strong> <span id="previewcurrentDate"></span></p>
</div>
<hr style="border: 0.5px dashed #000; margin: 5px 0;">


    <!-- Patient Details -->
    <div style="margin-bottom: 5px;">
        <p style="margin: 2px 0;"><strong>Patient Name:</strong> <span id="previewPatientName"></span></p>
        <p style="margin: 2px 0;"><strong>Age:</strong> <span id="previewAge"></span></p>
        <p style="margin: 2px 0;"><strong>Gender:</strong> <span id="previewGender"></span></p>
        <p style="margin: 2px 0;"><strong>Mobile:</strong> <span id="previewMobile"></span></p>
    </div>
    <hr style="border: 0.5px dashed #000; margin: 5px 0;">

    <!-- Prescription Details -->
    <div style="margin-bottom: 5px;">
        <h3 style="font-size: 9px; margin: 5px 0; text-align: center;">Prescription Details</h3>

        <!-- Right Eye Table -->
        <table style="width: 100%; border-collapse: collapse; font-size: 8px; margin-bottom: 10px;">
            <thead>
                <tr>
                    <th colspan="5">RIGHT EYE (OD)</th>
                </tr>
                <tr>
                    <th></th>
                    <th>SPH</th>
                    <th>CYL</th>
                    <th>AXIS</th>
                    <th>V/A</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>DIST</strong></td>
                    <td><span id="previewRightDistSPH"></span></td>
                    <td><span id="previewRightDistCYL"></span></td>
                    <td><span id="previewRightDistAXIS"></span></td>
                    <td><span id="previewRightDistVA"></span></td>
                </tr>
                <tr>
                    <td><strong>ADD</strong></td>
                    <td><span id="previewRightAddSPH"></span></td>
                    <td><span id="previewRightAddCYL"></span></td>
                    <td><span id="previewRightAddAXIS"></span></td>
                    <td><span id="previewRightAddVA"></span></td>
                </tr>
            </tbody>
        </table>

        <!-- Left Eye Table -->
        <table style="width: 100%; border-collapse: collapse; font-size: 8px;">
            <thead>
                <tr>
                    <th colspan="5">LEFT EYE (OS)</th>
                </tr>
                <tr>
                    <th></th>
                    <th>SPH</th>
                    <th>CYL</th>
                    <th>AXIS</th>
                    <th>V/A</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>DIST</strong></td>
                    <td><span id="previewLeftDistSPH"></span></td>
                    <td><span id="previewLeftDistCYL"></span></td>
                    <td><span id="previewLeftDistAXIS"></span></td>
                    <td><span id="previewLeftDistVA"></span></td>
                </tr>
                <tr>
                    <td><strong>ADD</strong></td>
                    <td><span id="previewLeftAddSPH"></span></td>
                    <td><span id="previewLeftAddCYL"></span></td>
                    <td><span id="previewLeftAddAXIS"></span></td>
                    <td><span id="previewLeftAddVA"></span></td>
                </tr>
            </tbody>
        </table>
    </div>
    <hr style="border: 0.5px dashed #000; margin: 5px 0;">

    <!-- Vision Type, Lens Type, Frame Type, and Payment Mode -->
    <div style="margin-bottom: 5px;">
        <p style="margin: 2px 0;"><strong>Vision Type:</strong> <span id="previewVisionType"></span></p>
        <p style="margin: 2px 0;"><strong>Lens Type:</strong> <span id="previewLensType"></span></p>
        <p style="margin: 2px 0;"><strong>Frame Type:</strong> <span id="previewFrameType"></span></p>
    </div>
    <hr style="border: 0.5px dashed #000; margin: 5px 0;">

    <!-- Amount -->
    <div style="margin-bottom: 5px;">
        <p style="margin: 2px 0;"><strong>Amount:</strong> â‚¹<span id="previewAmount"></span></p>
        <p style="margin: 2px 0;"><strong>Payment Mode:</strong> <span id="previewPaymentMode"></span></p>
    </div>
    <hr style="border: 0.5px dashed #000; margin: 5px 0;">

    <!-- Thank You Note -->
    <div style="text-align: center; font-size: 8px; margin-top: 5px;">
        <p style="margin: 2px 0;">Thank you for choosing</p>
        <p style="margin: 2px 0; font-weight: bold;">Srinidhi Eye Care & Optical!</p>
        <p style="margin: 2px 0;">We hope to see you again soon.</p>
    </div>
</div>
        <!-- Developer Credit -->
        <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #666;">
            App developed by <strong>Maniteja</strong>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

   <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzs3aR8Id1VC2X0OmNNRbOYrqMIQluKsQMgE12L6yqiWD8xzMwUepB9K8lqRb-W0IJ1/exec"; // Replace with your Google Apps Script URL
        
    document.addEventListener("DOMContentLoaded", function() {
        const username = localStorage.getItem("username");

        if (!username) {
            window.location.href = "login.html";
            return;
        }

        // Fetch user details from Google Sheets
        fetch(scriptURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },  // âœ… Fix: Added headers
    body: JSON.stringify({
        action: "updateProfile",
        username: username,
        clinicName: newClinicName,
        optometristName: newOptometristName,
        address: newAddress,
        contactNumber: newContactNumber
    })
})
        .then(response => response.json())
        .then(result => {
            if (result.status === "success") {
                document.getElementById("clinicName").textContent = result.clinicName;
                document.getElementById("clinicAddress").textContent = result.address;
                document.getElementById("optometristName").textContent = result.optometristName;
                document.getElementById("contactNumber").textContent = result.contactNumber;

                document.getElementById("previewClinicName").textContent = result.clinicName;
                document.getElementById("previewClinicAddress").textContent = result.address;
                document.getElementById("previewOptometristName").textContent = result.optometristName;
                document.getElementById("previewContactNumber").textContent = result.contactNumber;
            } else {
                alert("Error fetching clinic details. Please log in again.");
                localStorage.removeItem("username");
                window.location.href = "login.html";
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Failed to fetch clinic details. Please check your internet connection.");
        });

        // âœ… Set the Current Date
        document.getElementById("currentDate").textContent = new Date().toLocaleDateString();
        document.getElementById("previewcurrentDate").textContent = new Date().toLocaleDateString();
    });

    // âœ… Open Edit Profile Modal
    function openEditProfileModal() {
        document.getElementById("editProfileModal").style.display = "flex";
        document.getElementById("editClinicName").value = document.getElementById("clinicName").textContent;
        document.getElementById("editOptometristName").value = document.getElementById("optometristName").textContent;
        document.getElementById("editAddress").value = document.getElementById("clinicAddress").textContent;
        document.getElementById("editContactNumber").value = document.getElementById("contactNumber").textContent;
    }

    // âœ… Close Edit Profile Modal
    function closeEditProfileModal() {
        document.getElementById("editProfileModal").style.display = "none";
    }

    // âœ… Save Profile Changes
    function saveProfileChanges() {
        const username = localStorage.getItem("username");
        const newClinicName = document.getElementById("editClinicName").value.trim();
        const newOptometristName = document.getElementById("editOptometristName").value.trim();
        const newAddress = document.getElementById("editAddress").value.trim();
        const newContactNumber = document.getElementById("editContactNumber").value.trim();

        if (!newClinicName || !newOptometristName || !newAddress || !newContactNumber) {
            alert("All fields are required.");
            return;
        }

        console.log("Sending profile update request...");

        fetch(scriptURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },  // âœ… Ensures correct headers
            body: JSON.stringify({
                action: "updateProfile",
                username: username,
                clinicName: newClinicName,
                optometristName: newOptometristName,
                address: newAddress,
                contactNumber: newContactNumber
            })
        })
        .then(response => response.json())
        .then(result => {
            console.log("Response from server:", result);
            if (result.status === "success") {
                alert("Profile updated successfully!");
                document.getElementById("clinicName").textContent = newClinicName;
                document.getElementById("clinicAddress").textContent = newAddress;
                document.getElementById("optometristName").textContent = newOptometristName;
                document.getElementById("contactNumber").textContent = newContactNumber;

                document.getElementById("previewClinicName").textContent = newClinicName;
                document.getElementById("previewClinicAddress").textContent = newAddress;
                document.getElementById("previewOptometristName").textContent = newOptometristName;
                document.getElementById("previewContactNumber").textContent = newContactNumber;

                closeEditProfileModal();
            } else {
                alert("Failed to update profile. Please try again.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Failed to update profile. Please check your internet connection.");
        });
    }

    // âœ… Logout Function
    function logoutUser() {
        localStorage.removeItem("username");
        window.location.href = "login.html"; // Redirect to login page
    }
</script>
</body>
</html>
